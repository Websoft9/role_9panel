---
- name: Check HTTP Server type
  shell: "curl -Is http://127.0.0.1 | grep 'Server' |awk -F ': ' '{print $2}'|tr 'A-Z' 'a-z'"
  register: http_type

- name: Create apps directory
  file: 
      path: /data/apps
      state: directory
      owner: "{{http_type.stdout}}"
      group: "{{http_type.stdout}}"

# Remove if 9panel exist
- shell: rm -rf /data/apps/9panel

# Download from different region
- name: Download 9panel from Github
  git:
    repo: "{{ w9panel_download_url }}"
    dest: /data/apps/9panel
    version: latest
  when: region == '0' or region == 0

- block:
  - name: Download 9panel from OSS
    unarchive:
      src: "{{ w9panel_download_url }}"
      dest: /data/apps
      remote_src: yes

  - name: Rename directory name
    shell: if [ ! -d "/data/apps/9panel" ]; then mv *9panel* 9panel; fi 

when: region == '1' or region == 1

- name: set infrastructure of 9Panel to {{w9panel_set_infrastructure}}
  lineinfile:
    path: /data/apps/9panel/js/websoft9.js
    regexp: 'var set_infrastructure='
    line: 'var set_infrastructure="{{ w9panel_set_infrastructure }}";'

- name: set apps of 9Panel
  lineinfile:
    path: /data/apps/9panel/js/websoft9.js
    regexp: 'var set_apps='
    line: 'var set_apps={{ w9panel_set_apps | list }};'

- name: Set default site I
  shell: cp -rp /data/apps/9panel/*  /data/wwwroot/www.example.com

- name: Set default site II
  file:
    path: "/data/wwwroot/www.example.com/{{ item }}"
    state: absent
  with_items:
    - db.html
    - ftp.html
    - index.html
    - tools.html

- name: Set default site III
  command: mv /data/wwwroot/www.example.com/example.html /data/wwwroot/www.example.com/index.html

- name: Change apps directory Own
  file: 
      path: /data/apps
      owner: "{{http_type.stdout}}"
      group: "{{http_type.stdout}}"
      recurse: yes

- block:
  - name: Copy 9panel Configuration
    copy: src=9panel.conf dest=/etc/httpd/conf.d/

  - name: restart Apache
    service: name=httpd state=restarted enabled=yes
  when: http_type.stdout == "apache"

- block: 
  - name: Copy 9panel Configuration
    copy: src=9panel-nginx.conf dest=/etc/nginx/extra/9panel.conf

  - name: restart Nginx
    service: name=nginx state=restarted enabled=yes
  when: http_type.stdout == "nginx"
